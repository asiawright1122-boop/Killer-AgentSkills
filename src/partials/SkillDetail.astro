---
import Layout from '../layouts/Layout.astro';
import { translateTextStream } from '../lib/nvidia';
import { getKV, setKV } from '../lib/kv';
import { getCollection, getEntry } from 'astro:content';
import { 
    Star, 
    GitFork, 
    Calendar, 
    Github, 
    Terminal, 
    ChevronRight, 
    Home, 
    Layers,
    Copy,
    Check
} from 'lucide-react';

// 1. Generate static paths for all skills
export async function getStaticPaths() {
    const skills = await getCollection('skills');
    return skills.map(skill => {
        return {
            params: { slug: skill.id },
            props: { skill },
        };
    });
}

const { skill } = Astro.props;
const { data } = skill;
const currentLang = Astro.currentLocale || 'zh';

// Fallback description handling
let description = "";
if (typeof data.description === 'string') {
    description = data.description;
} else if (typeof data.description === 'object' && data.description) {
    description = data.description[currentLang] || data.description['en'] || Object.values(data.description)[0] || "";
}

// Construct OG Image URL
const ogServerUrl = import.meta.env.PUBLIC_OG_SERVER_URL;
const ogParams = new URLSearchParams({
    title: data.name,
    description: description.slice(0, 100),
    owner: data.owner,
    stars: String(data.stars || 0),
    topics: (data.topics || []).slice(0, 5).join(','),
});

const ogImageUrl = ogServerUrl 
    ? `${ogServerUrl}/api/og?${ogParams.toString()}`
    : `/og-image.png`;

const installCommand = `npx killer-skills install ${data.owner}/${data.repo}`;
---

<Layout title={`${data.name} - AI Skill`} description={description} image={ogImageUrl}>
    <main class="max-w-7xl mx-auto px-6 py-12">
        
        {/* Breadcrumbs */}
        <nav class="flex items-center text-sm font-medium text-slate-500 dark:text-slate-400 mb-8 overflow-x-auto whitespace-nowrap pb-2">
            <a href="/" class="hover:text-cyan-600 dark:hover:text-cyan-400 transition-colors flex items-center gap-1.5 cursor-pointer">
                <Home className="w-4 h-4" />
                <span>Home</span>
            </a>
            <ChevronRight className="w-4 h-4 mx-2 text-slate-300 dark:text-slate-600 flex-shrink-0" />
            <a href="/skills" class="hover:text-cyan-600 dark:hover:text-cyan-400 transition-colors flex items-center gap-1.5 cursor-pointer">
                <Layers className="w-4 h-4" />
                <span>Skills</span>
            </a>
            <ChevronRight className="w-4 h-4 mx-2 text-slate-300 dark:text-slate-600 flex-shrink-0" />
            <span class="text-slate-900 dark:text-slate-100 truncate">{data.name}</span>
        </nav>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
            
            {/* Left/Main Column: Content (8 cols) */}
            <div class="lg:col-span-8 space-y-10">
                {/* Header Section */}
                <header>
                    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-cyan-50 dark:bg-cyan-900/20 text-cyan-700 dark:text-cyan-300 text-xs font-semibold uppercase tracking-wider mb-4 border border-cyan-100 dark:border-cyan-800">
                        AI Agent Skill
                    </div>
                    <h1 class="text-5xl font-extrabold tracking-tight text-slate-900 dark:text-white mb-6">
                        {data.name}
                    </h1>
                    <p class="text-xl text-slate-600 dark:text-slate-300 leading-relaxed text-balance">
                        {description || "No description available."}
                    </p>
                    
                    {/* Tags */}
                    <div class="flex flex-wrap gap-2 mt-6">
                        {data.topics && data.topics.map((topic: string) => (
                            <span class="px-3 py-1 rounded-full text-sm font-medium bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-300 border border-slate-200 dark:border-slate-700 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors cursor-default">
                                {topic}
                            </span>
                        ))}
                    </div>
                </header>

                {/* Installation Section */}
                <section class="bg-slate-900 rounded-2xl p-1 shadow-xl ring-1 ring-slate-900/5 dark:ring-white/10 overflow-hidden">
                    <div class="flex items-center justify-between px-4 py-2 bg-slate-800/50 border-b border-white/5">
                        <div class="flex items-center gap-2">
                            <Terminal className="w-4 h-4 text-slate-400" />
                            <span class="text-sm font-medium text-slate-400">Installation</span>
                        </div>
                        <button 
                            class="copy-btn group relative p-1.5 rounded-md hover:bg-white/10 transition-colors cursor-pointer"
                            data-code={installCommand}
                            aria-label="Copy command"
                        >
                            <Copy className="w-4 h-4 text-slate-400 group-hover:text-white transition-colors" />
                            <Check className="w-4 h-4 text-emerald-400 absolute top-1.5 left-1.5 opacity-0 scale-75 transition-all check-icon" />
                        </button>
                    </div>
                    <div class="p-6 overflow-x-auto">
                        <code class="font-mono text-base text-cyan-400">
                            {installCommand}
                        </code>
                    </div>
                </section>

                {/* Main Content / README Placeholder */}
                <section class="prose prose-lg prose-slate dark:prose-invert max-w-none">
                    <h3 class="flex items-center gap-2 text-2xl font-bold">
                        Documentation
                    </h3>
                    <div class="p-8 rounded-2xl bg-slate-50 dark:bg-slate-900/50 border border-slate-100 dark:border-slate-800 text-center">
                        <div class="max-w-md mx-auto space-y-4">
                            <div class="w-16 h-16 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4">
                                <Layers className="w-8 h-8 text-slate-400" />
                            </div>
                            <h4 class="text-xl font-semibold text-slate-900 dark:text-white">Detailed Guide Coming Soon</h4>
                            <p class="text-slate-500 dark:text-slate-400">
                                We are currently working on extracting and formatting the full documentation for this skill. Start by installing it and exploring the CLI help.
                            </p>
                        </div>
                    </div>
                </section>
            </div>

            {/* Right Column: Stats & Meta (4 cols) */}
            <aside class="lg:col-span-4 space-y-6">
                
                {/* Glassmorphism Stats Card */}
                <div class="sticky top-6 p-6 rounded-2xl bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl border border-slate-200 dark:border-slate-800 shadow-lg ring-1 ring-slate-900/5">
                    <h3 class="text-sm font-semibold text-slate-900 dark:text-white uppercase tracking-wider mb-6">
                        Repository Stats
                    </h3>
                    
                    <div class="space-y-6">
                        <div class="flex items-center justify-between group">
                            <div class="flex items-center gap-3 text-slate-600 dark:text-slate-400">
                                <div class="p-2 rounded-lg bg-yellow-50 dark:bg-yellow-900/20 text-yellow-600 dark:text-yellow-400">
                                    <Star className="w-5 h-5" />
                                </div>
                                <span class="font-medium">Stars</span>
                            </div>
                            <span class="text-lg font-bold text-slate-900 dark:text-white font-mono group-hover:text-yellow-500 transition-colors">
                                {data.stars.toLocaleString()}
                            </span>
                        </div>

                        <div class="flex items-center justify-between group">
                            <div class="flex items-center gap-3 text-slate-600 dark:text-slate-400">
                                <div class="p-2 rounded-lg bg-purple-50 dark:bg-purple-900/20 text-purple-600 dark:text-purple-400">
                                    <GitFork className="w-5 h-5" />
                                </div>
                                <span class="font-medium">Forks</span>
                            </div>
                            <span class="text-lg font-bold text-slate-900 dark:text-white font-mono group-hover:text-purple-500 transition-colors">
                                {data.forks.toLocaleString()}
                            </span>
                        </div>

                        <div class="h-px bg-slate-200 dark:bg-slate-800 my-4"></div>

                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3 text-slate-600 dark:text-slate-400">
                                <div class="p-2 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400">
                                    <Calendar className="w-5 h-5" />
                                </div>
                                <span class="font-medium">Updated</span>
                            </div>
                           <span class="text-sm font-medium text-slate-900 dark:text-white">
                                {new Date(data.updatedAt).toLocaleDateString()}
                            </span>
                        </div>
                    </div>

                    <div class="mt-8 pt-6 border-t border-slate-200 dark:border-slate-800">
                        <a 
                            href={data.htmlUrl} 
                            target="_blank" 
                            rel="noopener noreferrer" 
                            class="flex items-center justify-center gap-2 w-full py-3 px-4 bg-slate-900 dark:bg-white text-white dark:text-slate-900 font-semibold rounded-xl hover:bg-slate-800 dark:hover:bg-slate-100 transition-all hover:scale-[1.02] shadow-md cursor-pointer"
                        >
                            <Github className="w-5 h-5" />
                            <span>View on GitHub</span>
                        </a>
                    </div>
                </div>

            </aside>
        </div>
    </main>
</Layout>

<script>
    // Copy button functionality
    document.querySelectorAll('.copy-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            const code = btn.getAttribute('data-code');
            const copyIcon = btn.querySelector('.lucide-copy');
            const checkIcon = btn.querySelector('.check-icon');

            try {
                await navigator.clipboard.writeText(code || '');
                
                // Toggle icons
                if (copyIcon) copyIcon.classList.add('opacity-0', 'scale-75');
                if (checkIcon) checkIcon.classList.remove('opacity-0', 'scale-75');

                setTimeout(() => {
                    if (copyIcon) copyIcon.classList.remove('opacity-0', 'scale-75');
                    if (checkIcon) checkIcon.classList.add('opacity-0', 'scale-75');
                }, 2000);
            } catch (err) {
                console.error('Failed to copy!', err);
            }
        });
    });
</script>
